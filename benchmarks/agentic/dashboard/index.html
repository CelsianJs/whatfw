<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agentic Debugging Benchmark — What Framework</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="header">
    <h1>Agentic Debugging Benchmark</h1>
    <p>What Framework DevTools MCP — proving agent-native debugging</p>
    <h2>With MCP vs Without MCP</h2>
  </div>

  <div id="content">
    <div class="no-data" id="no-data">
      <p>No benchmark results found.</p>
      <p>Run the benchmark first:</p>
      <code>ANTHROPIC_API_KEY=sk-... node runner.js</code>
      <p style="margin-top: 1rem">Then open this dashboard to see results.</p>
    </div>
  </div>

  <div class="footer">
    What Framework — The closest framework to vanilla JS. Agent-native by design.
  </div>

  <script type="module">
    import { drawBarChart, drawPieChart } from './chart.js';

    async function loadResults() {
      try {
        const resp = await fetch('../results/aggregate.json');
        if (!resp.ok) return null;
        return resp.json();
      } catch {
        return null;
      }
    }

    function renderDashboard(data) {
      const content = document.getElementById('content');
      const noData = document.getElementById('no-data');
      if (!data) { noData.style.display = 'block'; return; }
      noData.style.display = 'none';

      const { aggregate, fixtures } = data;
      const agg = aggregate;

      // Big numbers
      content.innerHTML = `
        <div class="big-numbers">
          <div class="big-number positive">
            <div class="value">${agg.delta.token_savings}</div>
            <div class="label">Token Savings</div>
          </div>
          <div class="big-number positive">
            <div class="value">${agg.delta.time_savings}</div>
            <div class="label">Time Savings</div>
          </div>
          <div class="big-number positive">
            <div class="value">${agg.delta.tool_call_reduction}</div>
            <div class="label">Fewer Tool Calls</div>
          </div>
          <div class="big-number">
            <div class="value">${agg.with_mcp.accuracy}</div>
            <div class="label">MCP Accuracy</div>
          </div>
          <div class="big-number">
            <div class="value">${agg.without_mcp.accuracy}</div>
            <div class="label">Baseline Accuracy</div>
          </div>
        </div>

        <div class="charts">
          <div class="chart-card">
            <canvas id="tokens-chart"></canvas>
          </div>
          <div class="chart-card">
            <canvas id="time-chart"></canvas>
          </div>
          <div class="chart-card">
            <canvas id="tools-chart"></canvas>
          </div>
          <div class="chart-card">
            <canvas id="tool-dist-chart"></canvas>
          </div>
        </div>

        <h2 style="text-align:center;margin-bottom:1.5rem">Per-Fixture Results</h2>
        <div class="fixture-grid" id="fixture-grid"></div>

        <div class="cost-calc">
          <h3>Cost Calculator</h3>
          <p class="detail">At Sonnet pricing ($3/$15 per 1M tokens)</p>
          <div class="cost-value" id="cost-savings">$0.00</div>
          <p class="detail">Saved per 100 debugging sessions</p>
        </div>
      `;

      // Draw charts
      const labels = fixtures.map(f => f.fixture.split('-')[0]);

      const avgMetric = (runs, key) => {
        const vals = runs.filter(r => !r.error).map(r => r[key] || 0);
        return vals.length ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
      };

      drawBarChart(document.getElementById('tokens-chart'), {
        labels,
        withoutValues: fixtures.map(f => avgMetric(f.without_mcp, 'total_tokens')),
        withValues: fixtures.map(f => avgMetric(f.with_mcp, 'total_tokens')),
        title: 'Total Tokens per Fixture',
      });

      drawBarChart(document.getElementById('time-chart'), {
        labels,
        withoutValues: fixtures.map(f => avgMetric(f.without_mcp, 'time_to_fix_ms') / 1000),
        withValues: fixtures.map(f => avgMetric(f.with_mcp, 'time_to_fix_ms') / 1000),
        title: 'Time to Fix (seconds)',
        unit: 's',
      });

      drawBarChart(document.getElementById('tools-chart'), {
        labels,
        withoutValues: fixtures.map(f => avgMetric(f.without_mcp, 'tool_calls')),
        withValues: fixtures.map(f => avgMetric(f.with_mcp, 'tool_calls')),
        title: 'Tool Calls per Fixture',
      });

      // Tool distribution pie for MCP mode
      const allToolBreakdowns = fixtures.flatMap(f =>
        f.with_mcp.filter(r => !r.error).map(r => r.tool_call_breakdown || {})
      );
      const toolTotals = {};
      for (const bd of allToolBreakdowns) {
        for (const [tool, count] of Object.entries(bd)) {
          toolTotals[tool] = (toolTotals[tool] || 0) + count;
        }
      }
      drawPieChart(document.getElementById('tool-dist-chart'), {
        entries: Object.entries(toolTotals)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 8)
          .map(([name, value]) => ({ name: name.replace('what_', ''), value })),
        title: 'MCP Tool Call Distribution',
      });

      // Fixture cards
      const grid = document.getElementById('fixture-grid');
      for (const f of fixtures) {
        const card = document.createElement('div');
        card.className = 'fixture-card';
        const wt = avgMetric(f.without_mcp, 'total_tokens');
        const mt = avgMetric(f.with_mcp, 'total_tokens');
        const wa = f.without_mcp.filter(r => r.fix_correct).length;
        const ma = f.with_mcp.filter(r => r.fix_correct).length;
        const total = f.without_mcp.length;
        card.innerHTML = `
          <div class="name">${f.fixture}</div>
          <div class="metric"><span class="label">Tokens</span><span class="without">${Math.round(wt).toLocaleString()}</span> → <span class="with">${Math.round(mt).toLocaleString()}</span></div>
          <div class="metric"><span class="label">Time</span><span class="without">${Math.round(avgMetric(f.without_mcp, 'time_to_fix_ms') / 1000)}s</span> → <span class="with">${Math.round(avgMetric(f.with_mcp, 'time_to_fix_ms') / 1000)}s</span></div>
          <div class="metric"><span class="label">Accuracy</span><span class="without">${wa}/${total}</span> → <span class="with">${ma}/${total}</span></div>
          <div class="metric"><span class="label">Tool Calls</span><span class="without">${Math.round(avgMetric(f.without_mcp, 'tool_calls'))}</span> → <span class="with">${Math.round(avgMetric(f.with_mcp, 'tool_calls'))}</span></div>
        `;
        grid.appendChild(card);
      }

      // Cost calculator
      const inputPrice = 3 / 1_000_000; // $3 per 1M
      const outputPrice = 15 / 1_000_000; // $15 per 1M
      const savedInput = (agg.without_mcp.avg_tokens - agg.with_mcp.avg_tokens) * 0.7; // ~70% input
      const savedOutput = (agg.without_mcp.avg_tokens - agg.with_mcp.avg_tokens) * 0.3;
      const savingsPer = savedInput * inputPrice + savedOutput * outputPrice;
      const savings100 = savingsPer * 100;
      document.getElementById('cost-savings').textContent = `$${savings100.toFixed(2)}`;
    }

    loadResults().then(renderDashboard);
  </script>
</body>
</html>
